# 【卡尔曼滤波器】1-递归算法_Recursive Processing

optimal recursive  Data Precessing Algorithm



![image-20220317181410905](images/image-20220317181410905.png)



![image-20220317185137341](images/image-20220317185137341.png)



![image-20220317185313460](images/image-20220317185313460.png)

![image-20220317185451855](images/image-20220317185451855.png)



> 卡尔曼滤波核心：
>
> 当前的估计值=上一次的估计值 +系数x（当前的测量值-上一次的估计值）

![image-20220318100640406](images/image-20220318100640406.png)



![image-20220318100730604](images/image-20220318100730604.png)

![image-20220318101832989](images/image-20220318101832989.png)







# 【卡尔曼滤波器】2-数学基础-数据融合-协方差矩阵-状态空间方程-观测器问题

> 本节：
>
> 1. 数据融合；
> 2. 协方差矩阵；
> 3. 状态空间方程；
> 4. 观测器问题

![image-20220318101926524](images/image-20220318101926524.png)

## 2.1数据融合

正态分布也叫高斯分布；



![image-20220318102242311](images/image-20220318102242311.png)

标准差：



![image-20220318102314525](images/image-20220318102314525.png)

> 补充：正态分布
>
> 1、定义：
>
> 若[随机变量](https://baike.baidu.com/item/随机变量/828980)X服从一个[数学期望](https://baike.baidu.com/item/数学期望/5362790)为μ、[方差](https://baike.baidu.com/item/方差/3108412)为σ2的正态分布，记为N(μ，σ2)。其[概率密度函数](https://baike.baidu.com/item/概率密度函数/5021996)为正态分布的[期望值](https://baike.baidu.com/item/期望值/8664642)μ决定了其位置，其[标准差](https://baike.baidu.com/item/标准差/1415772)σ决定了分布的幅度。当μ = 0,σ = 1时的正态分布是[标准正态分布](https://baike.baidu.com/item/标准正态分布)。
>
> 为了便于描述和应用，常将正态变量作数据转换。将一般正态分布转化成标准正态分布。
>
> 若
>
> ![img](images/01a91c9fd0fb903c925ffe1faa8bcbfe.svg)
>
> 2、分布曲线-面积分布
>
> 2.1 实际工作中，正态曲线下横轴上一定区间的面积（误差函数上下限之差）反映该区间的例数占总例数的百分比，或变量值落在该区间的概率（概率分布）。
>
> 2.2 正态曲线下，要取到50%概率，横轴半区间长度为0.67448975σ（该值无法用初等方法求解，是由迭代法取得的近似值。）
>
> [横轴](https://baike.baidu.com/item/横轴)区间（μ-σ,μ+σ）内的面积为68.268949%。
>
> ![img](images/3a72e8f6918fb287fe010e9e6352fb39.svg)
>
> 横轴区间（μ-2σ,μ+2σ）内的面积为95.449974%。
>
> ![img](images/3b39097d946e2bcac7f18d59cd4b19f8.svg)
>
> 横轴区间（μ-3σ,μ+3σ）内的面积为99.730020%。
>
> ![img](images/136c72bbc789ff6b44594a1162599fe8.svg)
>
> **“小概率事件”**和[假设检验](https://baike.baidu.com/item/假设检验)的基本思想： “小概率事件”通常指发生的概率小于5%的事件，认为在一次试验中该事件是几乎不可能发生的。由此可见X落在（μ-3σ,μ+3σ）以外的概率小于千分之三，在实际问题中常认为相应的事件不会发生，基本上可以把区间（μ-3σ,μ+3σ）看作是随机变量X实际可能的取值区间，这称之为正态分布的“3σ”原则。而对于产量更大，试验次数更多的大规模流水线产品，要达到“万无一失”（99.99%）就要取到4σ（99.9936%），而要达到更高的水平，则需要取5σ~6σ长度的半区间，此时误差大约是0.6[ppm](https://baike.baidu.com/item/ppm/19249422)~0.002ppm，这是工业生产中提出的“[六西格玛](https://baike.baidu.com/item/六西格玛/3346517)（6σ）”原则（管理学书籍中提及的六西格玛原则的要求是3.4ppm，这个概率值所对的分布大约在半区间长度4.5σ，这是考虑到系统误差造成的均值偏移μ=1.5σ的情况）。

## 2.2协方差矩阵

协方差矩阵P

![image-20220318102649612](images/image-20220318102649612.png)



> 1. 协方差（Covariance）
>
> 协方差（Covariance）在概率论和统计学中用于衡量两个变量的总体误差。而方差是协方差的一种特殊情况，即当两个变量是相同的情况。
>
> 协方差表示的是两个变量的总体的误差，这与只表示一个变量误差的方差不同**。如果两个变量的变化趋势一致，也就是说如果其中一个大于自身的期望值，另外一个也大于自身的期望值，那么两个变量之间的协方差就是正值——正相关**。如果两个变量的变化趋势相反，即其中一个大于自身的期望值，另外一个却小于自身的期望值，那么两个变量之间的协方差就是负值。
>
> 期望值分别为*E*[*X*]与*E*[*Y*]的两个实随机变量*X*与*Y*之间的**协方差***Cov(X,Y)*定义为：
>
> ![img](images/bd5a49802fd29c7a58bbba490f66ee93.svg)
>
> 2. 百度百科：
>
> 若两个随机变量X和Y相互独立，则E[(X-E(X))(Y-E(Y))]=0，因而若上述数学期望不为零，则X和Y必不是相互独立的，亦即它们之间存在着一定的关系。 
>
> - 协方差与方差之间有如下关系：
>
> D(X+Y)=D(X)+D(Y)+2Cov(X，Y)
>
> D(X-Y)=D(X)+D(Y)-2Cov(X，Y)
>
> - 协方差与期望值有如下关系：
>
> Cov(X，Y)=E(XY)-E(X)E(Y)。
>
> - 协方差的性质：
>
> （1）Cov(X，Y)=Cov(Y，X)；
>
> （2）Cov(*a*X，*b*Y)=*ab*Cov(X，Y)，（*a*，*b*是常数）；
>
> （3）Cov(X1+X2，Y)=Cov(X1，Y)+Cov(X2，Y)。
>
> （4）![img](images/2e944f15b479867135720c411e3d36dd.svg)
>
> 由协方差定义，可以看出Cov(X，X)=D(X)，Cov(Y，Y)=D(Y)。
>
> 【AP统计】期望E(X)与方差Var(X)：https://zhuanlan.zhihu.com/p/64859161)
>
> **3、方差**
>
> 方差在统计描述和概率分布中各有不同的定义，并有不同的公式。
>
> 3.1 
>
> 在统计描述中，方差用来计算每一个变量（观察值）与总体均数之间的差异。为避免出现离均差总和为零，离均差平方和受样本含量的影响，统计学采用平均离均差平方和来描述变量的变异程度。总体[方差计算公式](https://baike.baidu.com/item/方差计算公式/5318566)：
>
> ![img](images/4cbaee3df1b5e54daa15c0f9d4ab474b.svg)
>
> ![img](images/90764128004425a0234ddc6e13dce48b.svg)为总体方差，![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)为变量，![img](images/b7f43d75b3354a3bb6dccf21c32bdeff.svg)为总体均值，![img](images/63719b25aed7e9210356840b816ecdd1.svg)为总体例数。
>
> 实际工作中，总体均数难以得到时，应用样本统计量代替总体参数，经校正后，样本方差计算公式：
>
> ![img](images/29f832a79b0ec6eb740060cb0337de82.svg)
>
> ![img](images/a20300a4e7739fb05dded3ca381d7cb9.svg)为样本方差，![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)为变量，![img](images/b04967786ccf098067df49676176336f.svg)为样本均值，![img](images/561ce0d0c21ba2a257cc72a28956377b.svg)为样本例数。
>
> 3.2
>
> 在概率分布中，设![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)是一个离散型[随机变量](https://baike.baidu.com/item/随机变量)，若E((X-E(X))2)存在，则称E((X-E(X))2)为![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)的方差，记为![img](images/18e926c1ed91c624a539de25a62429da-164775784475424.svg)，![img](images/f8be811c46e43450264cdd2bf2dde558-164775784475426.svg)或![img](images/d777110d74c18e5596748980ef617295-164775784475428.svg)，其中![img](images/6ab47e4920ed4841d82568747f1c0380-164775784475430.svg)是![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)的期望值，![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)是变量值 [1] ，公式中的![img](images/bd8a13babb1c1b0b2f512636e81585f7-164775784475432.svg)是期望值expected value的缩写，意为“随机变量值与其期望值之差的平方”的期望值。 [2]
>
>  
>
> (1)[离散型随机变量](https://baike.baidu.com/item/离散型随机变量/9980865)方差计算公式：
>
> ![img](images/4b63ab2e13bc1cd3aaa328321b185bd1-164775784475434.svg)
>
> 当![img](images/a94f73fb4ed073410711da97d8d9e245.svg)称为变量![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)的方差，而![img](images/24e4639c8cc3c865d708e9f0415601ce.svg)称为标准差（或[均方差](https://baike.baidu.com/item/均方差)）。它与![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)有相同的量纲。标准差是用来衡量一组数据的离散程度的[统计量](https://baike.baidu.com/item/统计量) [3] 。
>
> 
>
> (2)对于[连续型随机变量](https://baike.baidu.com/item/连续型随机变量/3318213)![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)，若其定义域为![img](images/ddfdb3271b3f366a6dd1fdfbae4bff1d.svg)，[概率密度函数](https://baike.baidu.com/item/概率密度函数/5021996)为![img](images/2174d654998d2bd6b79ed2e180d595ff.svg)，连续型随机变量X方差计算公式 [2] ：
>
> ![img](images/75bb60ad0f933773c375b89bfb94956e.svg)
>
> 方差刻画了随机变量的取值对于其数学期望的[离散程度](https://baike.baidu.com/item/离散程度)。（标准差、方差越大，离散程度越大）
>
> 若X的取值比较集中，则方差![img](images/18e926c1ed91c624a539de25a62429da-164775784475424.svg)较小，若X的取值比较分散，则方差![img](images/18e926c1ed91c624a539de25a62429da-164775784475424.svg)较大。
>
> 因此，![img](images/18e926c1ed91c624a539de25a62429da-164775784475424.svg)是刻画![img](images/9f7d1d2e6f98698b18cf0939756901ac-164775784475416.svg)取值分散程度的一个量，它是衡量取值分散程度的一个尺度。



### 协方差矩阵的快捷求法

矩阵运算，编程方便；

![image-20220318105122135](images/image-20220318105122135.png)





## 2.3状态空间方程

![image-20220318105347685](images/image-20220318105347685.png)



![image-20220318105429302](images/image-20220318105429302.png)





![image-20220318105523756](images/image-20220318105523756.png)











## 2.4 观测器问题

![image-20220318105712056](images/image-20220318105712056.png)

注：应该为`u()`

估计hatX；



 

# 【卡尔曼滤波器】3_卡尔曼增益超详细数学推导 ～全网最完整



> https://zhuanlan.zhihu.com/p/64859161

![image-20220320144923198](images/image-20220320144923198.png)

![image-20220320145000923](images/image-20220320145000923.png)

$$R=E\left[ v_kv_{k}^{T} \right]$$

注意：建模的过程中，w(k+1)与v(k+1)是不知道的，



去掉过程噪声，依据现有的状态方程建模，只能得到一个先验估计值$$
\hat{x}^-
$$；

> 卡尔曼滤波核心：
>
> **当前的估计值=上一次的估计值 +系数x（当前的测量值-上一次的估计值）**
>
> 此处：
>
> 后验估计值=先验估计值+G(测量值-先验估计值)
>
> 卡尔曼滤波结果=算出来的结果+G(测出来的结果-算出来的结果)



![image-20220320145853056](images/image-20220320145853056.png)

![image-20220320150113409](images/image-20220320150113409.png)

![image-20220320151401355](images/image-20220320151401355.png)



![image-20220320151728849](images/image-20220320151728849.png)

要寻找使得协方差矩阵的迹（误差的平方和）最小，对矩阵求偏导数；

![image-20220320153000330](images/image-20220320153000330.png)



![image-20220320153047430](images/image-20220320153047430.png)









# 【卡尔曼滤波器】4-误差协方差矩阵数学推导-卡尔曼滤波器的五个公式



## 4.1 误差协方差矩阵数学推导

![image-20220320153247768](images/image-20220320153247768.png)

![image-20220320153314882](images/image-20220320153314882.png)



怎么求？

![image-20220320153431491](images/image-20220320153431491.png)



![image-20220320153657867](images/image-20220320153657867.png)



> 1）![image-20220320153636849](images/image-20220320153636849.png)
>
> 2）当X和Y相互独立时，![img](images/3d94ef2cfb35ed72bd471a102e697673.svg)
>
> 3）![image-20220320153926504](images/image-20220320153926504.png)![image-20220320153936444](images/image-20220320153936444.png)

![image-20220320154034286](images/image-20220320154034286.png)



## 4.2 卡尔曼滤波器的五个公式：

![image-20220318152429020](images/image-20220318152429020.png)



### 上一次的误差协方差的推导：

![image-20220320154557404](images/image-20220320154557404.png)

### 初值的问题：hatx的初值与误差协方差的初值；

![image-20220320154640224](images/image-20220320154640224.png)





# 【卡尔曼滤波器】5_直观理解与二维实例【包含完整的EXCEL代码】

> 二维线性卡尔曼滤波器

![image-20220320154640224](images/image-20220320154640224.png)



![image-20220320155208707](images/image-20220320155208707.png)







![image-20220320162926227](images/image-20220320162926227.png)



## QR两个矩阵的调参

（1）过程噪声协方差矩阵P：

如果状态量[x1，x2]的过程噪声[w1，w2]是相互独立的，就只有各自的方差，没有协方差；如果要设置协方差可以按照以下规律：

> 协方差表示的是两个变量的总体的误差，这与只表示一个变量误差的方差不同**。如果两个变量的变化趋势一致，也就是说如果其中一个大于自身的期望值，另外一个也大于自身的期望值，那么两个变量之间的协方差就是正值——正相关**。如果两个变量的变化趋势相反，即其中一个大于自身的期望值，另外一个却小于自身的期望值，那么两个变量之间的协方差就是负值。

（2）测量噪声协方差矩阵R：

如果测量量[z1，z2]的测量噪声[v1，v2]是相互独立的，就只有各自的方差，没有协方差；如果要设置协方差可以按照以下规律：



![image-20220320162945150](images/image-20220320162945150.png)



$\kappa$



# 【卡尔曼滤波器】6-扩展卡尔曼滤波器-Extended Kalman Filter

> 非线性系统线性化；



## 6.1 线性卡尔曼滤波器（回顾）

符合正态分布。

![image-20220320160143520](images/image-20220320160143520.png)



## 6.2 非线性卡尔曼滤波器



![image-20220320160413339](images/image-20220320160413339.png)

> 线性化方法一：Taylor Series Based Approximations 基于泰勒级数的近似

> 高维的非线性；涉及雅克比矩阵，参考视频：
>
> <img src="images/image-20220320160443689.png" alt="image-20220320160443689" style="zoom:67%;" />

### 6.2.1过程方程线性化

在上一次的后验估计值处进行泰勒展开；

![image-20220320160831724](images/image-20220320160831724.png)

> 注1：测量误差$w_{k-1}$是未知的，所以可以假设为0；进一步简化为<img src="images/image-20220320161702314.png" alt="image-20220320161702314" style="zoom:80%;" />
>
> 注2：A为雅克比矩阵；<img src="images/image-20220320161506520.png" alt="image-20220320161506520" style="zoom:80%;" />；二维例子见下图。 $$A=\frac{\partial f}{\partial x}_{\hat{x}_{k-1}}$$
>
> 注3：$w_k$也是雅克比矩阵；<img src="images/image-20220320161623659.png" alt="image-20220320161623659" style="zoom:80%;" />；同理；
>
> ## 泰勒级数定义
>
> 如果 ![[公式]](images/equation.svg) 在点 ![[公式]](images/equation.svg) 具有任意阶导数，则幂级数
>
> ![[公式]](images/cdots.svg)
>
> 称为![[公式]](images/equation.svg)在点 $x_0$  处的泰勒级数。



![image-20220320161126410](images/image-20220320161126410.png)

### 6.2.2测量方程的线性化

在$$\tilde{x}$$处进行泰勒展开；

![image-20220320161858307](images/image-20220320161858307.png)



![image-20220320162213462](images/image-20220320162213462.png)



### 6.2.3非线性卡尔曼滤波-扩展卡尔曼滤波



![image-20220320160143520](images/image-20220320160143520.png)



![image-20220320162508141](images/image-20220320162508141.png)



> 一个实例：
>
> https://blog.csdn.net/qwe900/article/details/109480327



